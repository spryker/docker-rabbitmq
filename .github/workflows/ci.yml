name: CI/CD - Local Compare Only

on: [push]

jobs:
  compare-images:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build rabbitmq 3.12 (Previous Image)
        run: |
          echo "ğŸ”¨ Building rabbitmq 3.12 as previous image"
          docker build -f 3.12/Dockerfile -t rabbitmq:3.12 .

      - name: Build rabbitmq 3.13 (Current Image)
        run: |
          echo "ğŸ”¨ Building rabbitmq 3.13 as current image"
          docker build -f 3.13/Dockerfile -t rabbitmq:3.13 .

      - name: Generate current image report
        run: |
          echo "ğŸ“¦ Generating current image report (3.13)"
          bash .github/compare-images.sh rabbitmq:3.13 > current-image-report.txt || true
          cat current-image-report.txt

      - name: Generate previous image report
        run: |
          echo "ğŸ“¦ Generating previous image report (3.12)"
          bash .github/compare-images.sh rabbitmq:3.12 > previous-image-report.txt || true
          cat previous-image-report.txt

      - name: Run the diff and format output
        run: |
          echo "ğŸ“„ === Previous Image Report (3.12) ==="
          cat previous-image-report.txt
          
          echo -e "\nğŸ“„ === Current Image Report (3.13) ==="
          cat current-image-report.txt
          
          echo -e "\nğŸ” Running diff..."
          bash .github/format-output.sh
          
          echo -e "\nğŸ“‹ === Diff Output ==="
          cat diff-output.txt
