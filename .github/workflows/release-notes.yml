name: Generate Release Notes on Merge

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - master
      - SC-24082-release-notes-refactor
jobs:
  generate_notes:
    name: üìú Generate Release Notes
    runs-on: ubuntu-latest
    outputs:
      release_date: ${{ steps.assemble.outputs.release_date }}
      last_updated_str: ${{ steps.assemble.outputs.last_updated_str }}
      publish_date: ${{ steps.assemble.outputs.publish_date }}
    steps:
      - name: ‚úçÔ∏è Extract Sections from PR Body
        id: extract
        env:
          PR_BODY_RAW: ${{ github.event.pull_request.body }}
        run: |
          # Clean and normalize the PR body, remove checklist section
          PR_BODY=$(echo "$PR_BODY_RAW" | tr -d '\r' | sed '/^## Checklist/,$d')
          
          # Extract improvements (after "### Improvements" and before "### Security Fixes")
          IMPROVEMENTS=$(echo "$PR_BODY" | awk '/^### Improvements/{flag=1;next}/^### Security Fixes|^### Version release notes/{flag=0}flag')
          echo "improvements<<EOF" >> $GITHUB_OUTPUT
          echo "$IMPROVEMENTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Extract security fixes (after "### Security Fixes" and before "### Version release notes")
          SECURITY_FIXES=$(echo "$PR_BODY" | awk '/^### Security Fixes/{flag=1;next}/^### Version release notes/{flag=0}flag')
          echo "security_fixes<<EOF" >> $GITHUB_OUTPUT
          echo "$SECURITY_FIXES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Extract version release notes (after "### Version release notes" and before end or next section)
          VERSION_NOTES=$(echo "$PR_BODY" | awk '/^### Version release notes/{flag=1;next}/^##/{flag=0}flag')
          echo "version_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$VERSION_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üì¶ Assemble Release Notes Block
        id: assemble
        run: |
          RELEASE_DATE=$(date +'%Y%m%d')
          echo "release_date=$RELEASE_DATE" >> $GITHUB_OUTPUT
          
          PUBLISH_DATE=$(date +'%Y-%m-%d')
          echo "publish_date=$PUBLISH_DATE" >> $GITHUB_OUTPUT
          
          LAST_UPDATED_STR=$(date +'%B %d, %Y')
          echo "last_updated_str=$LAST_UPDATED_STR" >> $GITHUB_OUTPUT

          # Process version notes to convert bare URLs to proper markdown links
          PROCESSED_VERSION_NOTES=$(echo '${{ steps.extract.outputs.version_notes }}' | \
            sed -E 's|([^(])(https?://[^ )]+)|\1[\2](\2)|g')

          cat << 'TEMPLATE_EOF' > release-notes-new-file.md
          ---
          title: Release notes for spryker-rabbitmq RELEASE_DATE_PLACEHOLDER
          description: This document describes the changes that have been recently released.
          last_updated: LAST_UPDATED_PLACEHOLDER
          template: concept-topic-template
          publish_date: "PUBLISH_DATE_PLACEHOLDER"
          ---

          This document describes the changes that have been recently released.
          For additional support with this content, contact our support.
          If you found a new security vulnerability, contact us at **security@spryker.com**.

          ---

          ## Release notes for spryker-rabbitmq RELEASE_DATE_PLACEHOLDER

          **Improvements**:

          IMPROVEMENTS_PLACEHOLDER

          ### Security Fixes

          SECURITY_FIXES_PLACEHOLDER

          ### Version release notes

          VERSION_NOTES_PLACEHOLDER
          TEMPLATE_EOF

          # Replace placeholders
          sed -i "s|RELEASE_DATE_PLACEHOLDER|$RELEASE_DATE|g" release-notes-new-file.md
          sed -i "s|LAST_UPDATED_PLACEHOLDER|$LAST_UPDATED_STR|g" release-notes-new-file.md
          sed -i "s|PUBLISH_DATE_PLACEHOLDER|$PUBLISH_DATE|g" release-notes-new-file.md
          sed -i "s|IMPROVEMENTS_PLACEHOLDER|${{ steps.extract.outputs.improvements }}|g" release-notes-new-file.md
          sed -i "s|SECURITY_FIXES_PLACEHOLDER|${{ steps.extract.outputs.security_fixes }}|g" release-notes-new-file.md
          sed -i "s|VERSION_NOTES_PLACEHOLDER|${PROCESSED_VERSION_NOTES}|g" release-notes-new-file.md

          echo "::group::üìú New Release Notes File"
          cat release-notes-new-file.md
          echo "::endgroup::"
          
      - name: üì§ Upload Release Notes Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-artifact
          path: release-notes-new-file.md

  create-release-pr:
    name: üìÑ Create Release Notes PR in Docs Repo
    needs: generate_notes
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: üì• Download Release Notes Artifact
        uses: actions/download-artifact@v4
        with:
          name: release-notes-artifact

      - name: Checkout Documentation Repository
        uses: actions/checkout@v4
        with:
          repository: spryker/spryker-docs
          token: ${{ secrets.DOCS_REPO_PAT }}
          path: docs-repo

      - name: üìù Create New Release Notes File
        run: |
          RELEASE_DATE="${{ needs.generate_notes.outputs.release_date }}"
          TARGET_DIR="./docs-repo/docs/about/all/releases/image-releases/rabbitmq"
          TARGET_FILE="$TARGET_DIR/release-notes-spryker-rabbitmq-$RELEASE_DATE.md"
          
          echo "Creating new release notes file: $TARGET_FILE"
          mkdir -p "$TARGET_DIR"
          
          cp release-notes-new-file.md "$TARGET_FILE"
          echo "‚úÖ Created $TARGET_FILE"

      - name: üìã Update Sidebar Navigation
        run: |
          RELEASE_DATE="${{ needs.generate_notes.outputs.release_date }}"
          SIDEBAR_FILE="./docs-repo/_data/sidebars/about_all_sidebar.yml"
          
          echo "Updating sidebar: $SIDEBAR_FILE"
          
          # Find the line containing "Image releases" under "Releases"
          IMAGE_RELEASES_LINE=$(grep -n "title: Image releases" "$SIDEBAR_FILE" | cut -d: -f1)
          
          if [ -z "$IMAGE_RELEASES_LINE" ]; then
            echo "‚ùå Could not find 'Image releases' section in sidebar"
            exit 1
          fi
          
          # Check if RabbitMQ section already exists
          if grep -q "title: Release notes for RabbitMQ" "$SIDEBAR_FILE"; then
            echo "RabbitMQ section found, adding new entry..."
            # Find the line number where "Release notes for RabbitMQ" is located
            RABBITMQ_LINE=$(grep -n "title: Release notes for RabbitMQ" "$SIDEBAR_FILE" | cut -d: -f1)
            
            # Insert the new entry as the first item under "Release notes for RabbitMQ"
            # We need to find the "nested:" line after "Release notes for RabbitMQ"
            NESTED_LINE=$((RABBITMQ_LINE + 2))
            
            # Create the new entry with proper indentation (12 spaces)
            NEW_ENTRY="            - title: Release notes for spryker-rabbitmq $RELEASE_DATE
              url: /docs/about/all/releases/image-releases/rabbitmq/release-notes-spryker-rabbitmq-$RELEASE_DATE.html"
            
            # Insert at the beginning of the nested section
            awk -v line="$NESTED_LINE" -v entry="$NEW_ENTRY" 'NR==line{print entry; print; next}1' "$SIDEBAR_FILE" > "$SIDEBAR_FILE.tmp"
            mv "$SIDEBAR_FILE.tmp" "$SIDEBAR_FILE"
            echo "‚úÖ Added new entry to existing RabbitMQ section"
          else
            echo "RabbitMQ section not found, creating new section..."
            # Find where to insert (after "Image releases" nested section starts)
            INSERT_LINE=$((IMAGE_RELEASES_LINE + 2))
            
            # Create the entire RabbitMQ section
            NEW_SECTION="          - title: Release notes for RabbitMQ
            nested:
            - title: Release notes for spryker-rabbitmq $RELEASE_DATE
              url: /docs/about/all/releases/image-releases/rabbitmq/release-notes-spryker-rabbitmq-$RELEASE_DATE.html"
            
            # Insert the new section
            awk -v line="$INSERT_LINE" -v entry="$NEW_SECTION" 'NR==line{print entry; print; next}1' "$SIDEBAR_FILE" > "$SIDEBAR_FILE.tmp"
            mv "$SIDEBAR_FILE.tmp" "$SIDEBAR_FILE"
            echo "‚úÖ Created new RabbitMQ section with entry"
          fi
          
          echo "::group::üìã Updated Sidebar"
          cat "$SIDEBAR_FILE"
          echo "::endgroup::"

      - name: üöÄ Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.DOCS_REPO_PAT }}
          path: ./docs-repo
          commit-message: "docs: Add release notes for spryker-rabbitmq ${{ needs.generate_notes.outputs.release_date }}"
          branch: "docs/docker-images/release-notes-spryker-rabbitmq-${{ needs.generate_notes.outputs.release_date }}"
          title: "Release Notes for spryker-rabbitmq ${{ needs.generate_notes.outputs.release_date }}"
          body: |
            This PR contains the release notes for spryker-rabbitmq ${{ needs.generate_notes.outputs.release_date }}.
            
            **Changes:**
            - Created new release notes file: `release-notes-spryker-rabbitmq-${{ needs.generate_notes.outputs.release_date }}.md`
            - Updated sidebar navigation in `about_all_sidebar.yml`
            
            Please review and merge. ‚úÖ
          labels: "automation"
          base: master